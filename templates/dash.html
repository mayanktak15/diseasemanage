{% extends 'base.html' %}
{% block title %}Dashboard - Docify Online{% endblock %}
{% block extra_head %}
<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .slide-in { animation: slideIn 0.4s ease-out; }
    .chat-message { animation: fadeIn 0.3s ease-out; }
    .gradient-bg { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
    .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); transition: all 0.3s ease; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4); }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Column - Consultations -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Welcome Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover fade-in">
            <div class="flex items-center space-x-4">
                <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-4 rounded-full">
                    <i class="fas fa-user-md text-white text-2xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Welcome back, {{ user.name }}!</h2>
                    <p class="text-gray-600">Manage your health consultations with ease</p>
                </div>
            </div>
        </div>

        <!-- Consultation Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex items-center space-x-3 mb-4">
                <i class="fas fa-file-medical text-blue-600 text-2xl"></i>
                <h3 class="text-2xl font-bold text-gray-800">New Consultation</h3>
            </div>
            <form method="POST" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-notes-medical mr-2"></i>Describe Your Symptoms
                    </label>
                    <textarea name="symptoms" rows="5" class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition outline-none" placeholder="Please describe your symptoms in detail (e.g., duration, severity, any relevant medical history)..." required></textarea>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Include details like when symptoms started, severity, and any medications you're taking
                    </p>
                </div>
                <button type="submit" class="btn-primary w-full text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center space-x-2">
                    <i class="fas fa-paper-plane"></i>
                    <span>Submit Consultation</span>
                </button>
            </form>
        </div>

        <!-- Consultations History -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-history text-blue-600 text-2xl"></i>
                    <h3 class="text-2xl font-bold text-gray-800">Consultation History</h3>
                </div>
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">{{ consultations|length }} Total</span>
            </div>

            {% if consultations %}
            <div class="space-y-4 max-h-96 overflow-y-auto scrollbar-hide">
                {% for consultation in consultations %}
                <div class="border-l-4 {% if consultation.status == 'completed' %}border-green-600{% elif consultation.status == 'reviewed' %}border-yellow-600{% else %}border-blue-600{% endif %} bg-gray-50 p-4 rounded-lg hover:shadow-md transition card-hover" id="consultation-{{ consultation.id }}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500 flex items-center">
                                <i class="far fa-calendar-alt mr-2"></i>
                                {{ consultation.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                            </span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold {% if consultation.status == 'completed' %}bg-green-100 text-green-800{% elif consultation.status == 'reviewed' %}bg-yellow-100 text-yellow-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                <i class="fas {% if consultation.status == 'completed' %}fa-check-circle{% elif consultation.status == 'reviewed' %}fa-eye{% else %}fa-clock{% endif %} mr-1"></i>
                                {{ consultation.status|capitalize }}
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <a href="{{ url_for('update_consultation', id=consultation.id) }}" class="text-blue-600 hover:text-blue-800 font-semibold flex items-center space-x-1 text-sm transition">
                                <i class="fas fa-edit"></i><span>Edit</span>
                            </a>
                            <button data-id="{{ consultation.id }}" class="delete-btn text-red-600 hover:text-red-800 font-semibold flex items-center space-x-1 text-sm transition">
                                <i class="fas fa-trash-alt"></i><span>Delete</span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-md">
                        <p class="text-gray-700 leading-relaxed">{{ consultation.symptoms }}</p>
                        {% if consultation.doctor_notes %}
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <p class="text-sm font-semibold text-blue-700 mb-1"><i class="fas fa-user-md mr-1"></i>Doctor's Notes:</p>
                            <p class="text-sm text-gray-600 italic">{{ consultation.doctor_notes }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-folder-open text-6xl mb-4"></i>
                <p class="text-lg font-medium">No consultations yet</p>
                <p class="text-sm">Submit your first consultation above to get started</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Right Column - Chatbot -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-lg sticky top-8">
            <div class="gradient-bg text-white p-4 rounded-t-xl">
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <i class="fas fa-robot text-3xl"></i>
                        <span class="absolute -top-1 -right-1 flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">Medical Assistant</h3>
                        <p class="text-sm text-gray-200">Online ‚Ä¢ Ready to help</p>
                    </div>
                </div>
            </div>

            <div id="chatbox" class="p-4 h-96 overflow-y-auto bg-gray-50 space-y-3">
                <div class="chat-message flex items-start space-x-2">
                    <div class="bg-blue-100 p-2 rounded-full"><i class="fas fa-robot text-blue-600"></i></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm max-w-sm">
                        <div class="text-sm text-gray-700 leading-relaxed">
                            <p class="font-semibold text-blue-700 mb-2">üëã Hello! I'm your medical assistant.</p>
                            <p>I can help you with:</p>
                            <div class="mt-2 space-y-1">
                                <div class="flex items-start"><span class="text-blue-600 mr-2">‚Ä¢</span><span>Information about Docify Online</span></div>
                                <div class="flex items-start"><span class="text-blue-600 mr-2">‚Ä¢</span><span>General health guidance</span></div>
                                <div class="flex items-start"><span class="text-blue-600 mr-2">‚Ä¢</span><span>How to submit consultations</span></div>
                                <div class="flex items-start"><span class="text-blue-600 mr-2">‚Ä¢</span><span>Platform FAQs</span></div>
                            </div>
                            <p class="mt-3 text-gray-600">How can I help you today?</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-200">
                <div class="flex space-x-2">
                    <input id="chat-input" type="text" class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition outline-none" placeholder="Type your question...">
                    <button id="chat-send" class="btn-primary text-white px-5 py-3 rounded-lg font-semibold hover:shadow-lg transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 flex items-center"><i class="fas fa-info-circle mr-1"></i>Press Enter to send your message</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
        const chatbox = document.getElementById('chatbox');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');

        // Function to format text with proper styling
        function formatBotMessage(text) {
            // Escape HTML first to prevent XSS
            const tempDiv = document.createElement('div');
            tempDiv.textContent = text;
            let formatted = tempDiv.innerHTML;
            
            // Split into lines first
            let lines = formatted.split('\n');
            let result = [];
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                if (line === '') {
                    if (inList) {
                        result.push('</div>');
                        inList = false;
                    }
                    result.push('<div class="mb-2"></div>');
                    continue;
                }
                
                // Check for section headers with emojis and **text**
                if (line.match(/^[üå°Ô∏è‚ö†Ô∏èüìãüè•ü©∫üë®‚Äç‚öïÔ∏èüíäüîç]\s*\*\*(.+?)\*\*/)) {
                    if (inList) {
                        result.push('</div>');
                        inList = false;
                    }
                    line = line.replace(/\*\*(.+?)\*\*/g, '<strong class="font-bold text-gray-900">$1</strong>');
                    result.push('<div class="mb-2 mt-3">' + line + '</div>');
                }
                // Check for bullet points
                else if (line.startsWith('-')) {
                    if (!inList) {
                        result.push('<div class="space-y-1 ml-2">');
                        inList = true;
                    }
                    let content = line.substring(1).trim();
                    result.push('<div class="flex items-start"><span class="text-blue-600 mr-2 mt-0.5">‚Ä¢</span><span class="flex-1">' + content + '</span></div>');
                }
                // Regular text
                else {
                    if (inList) {
                        result.push('</div>');
                        inList = false;
                    }
                    // Format inline bold
                    line = line.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>');
                    result.push('<div class="mb-1">' + line + '</div>');
                }
            }
            
            if (inList) {
                result.push('</div>');
            }
            
            return result.join('');
        }

        // Function to create message element
        function createMessage(text, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message flex items-start space-x-2 ${isUser ? 'justify-end' : ''}`;
            
            if (isUser) {
                const tempDiv = document.createElement('div');
                tempDiv.textContent = text;
                const escapedText = tempDiv.innerHTML;
                
                messageDiv.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-3 rounded-lg shadow-md max-w-xs">
                        <p class="text-sm text-white whitespace-pre-wrap break-words">${escapedText}</p>
                    </div>
                    <div class="bg-blue-200 p-2 rounded-full">
                        <i class="fas fa-user text-blue-700"></i>
                    </div>
                `;
            } else {
                const formattedText = formatBotMessage(text);
                
                messageDiv.innerHTML = `
                    <div class="bg-blue-100 p-2 rounded-full flex-shrink-0">
                        <i class="fas fa-robot text-blue-600"></i>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md max-w-md lg:max-w-lg">
                        <div class="text-sm text-gray-700 leading-relaxed space-y-1">${formattedText}</div>
                    </div>
                `;
            }
            
            return messageDiv;
        }

        // Function to create loading message
        function createLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message flex items-start space-x-2';
            loadingDiv.id = 'loading-message';
            loadingDiv.innerHTML = `
                <div class="bg-blue-100 p-2 rounded-full">
                    <i class="fas fa-robot text-blue-600"></i>
                </div>
                <div class="bg-white p-3 rounded-lg shadow-sm">
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;
            return loadingDiv;
        }

        // Function to send message
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (message === '') return;

            // Add user message
            chatbox.appendChild(createMessage(message, true));
            chatInput.value = '';
            chatbox.scrollTop = chatbox.scrollHeight;

            // Show loading message
            const loadingMsg = createLoadingMessage();
            chatbox.appendChild(loadingMsg);
            chatbox.scrollTop = chatbox.scrollHeight;

            try {
                const response = await fetch('/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Remove loading message
                loadingMsg.remove();
                
                // Add bot response
                chatbox.appendChild(createMessage(data.reply || 'No response received.', false));
                chatbox.scrollTop = chatbox.scrollHeight;
                
            } catch (error) {
                console.error('Chatbot error:', error);
                
                // Remove loading message
                loadingMsg.remove();
                
                // Add error message
                chatbox.appendChild(createMessage(
                    '‚ö†Ô∏è Sorry, I\'m having technical difficulties. Please try again or contact support.',
                    false
                ));
                chatbox.scrollTop = chatbox.scrollHeight;
            }
        }

        // Event listeners
        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Add fade-in animation to existing elements
        document.addEventListener('DOMContentLoaded', function() {
            const elements = document.querySelectorAll('.fade-in, .slide-in, .card-hover');
            elements.forEach((el, index) => {
                el.style.animationDelay = `${index * 0.1}s`;
            });
        });

    // Delete Consultation Function
        async function deleteConsultation(id) {
            if (!confirm('Are you sure you want to delete this consultation? This action cannot be undone.')) {
                return;
            }

            // Event delegation for delete buttons to avoid inline handlers
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('.delete-btn');
                if (btn) {
                    const id = btn.getAttribute('data-id');
                    if (id) {
                        deleteConsultation(id);
                    }
                }
            });

            try {
                const response = await fetch(`/delete_consultation/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    // Remove the consultation card with animation
                    const card = document.getElementById(`consultation-${id}`);
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(-100%)';
                    
                    setTimeout(() => {
                        card.remove();
                        // Show success message
                        alert('Consultation deleted successfully!');
                        // Reload page to update count
                        location.reload();
                    }, 300);
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete consultation. Please try again.');
            }
    }
</script>
{% endblock %}
